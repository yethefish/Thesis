@page "/"
@namespace Pages

<div class="map-container">
    <div class="top-bar">
        <div class="top-bar-left">
            <form class="search-form-view">
                <div class="search-form-view-input">
                    <input type="text" id="address-input" placeholder="Поиск локации" class="search-input" />
                </div>
                <div class="search-form-view-button">
                    <button type="button" id="search-button" class="button" @onclick="SearchAddress">
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                            <path d="M9.5 2a7.5 7.5 0 1 0 4.14 13.755l3.946 4.66a2 2 0 1 0 2.828-2.83l-4.659-3.945A7.5 7.5 0 0 0 9.5 2zM4 9.5a5.5 5.5 0 1 1 11 0 5.5 5.5 0 0 1-11 0z"/>
                        </svg>
                    </button>
                </div>
                <div class="search-form-view-button">
                    <button type="button" id="lock-button" class="button" @onclick="ToggleLock">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path id="lock-shackle" d="M16 10V6a4 4 0 0 0-8-2"/> 
                            <rect x="5" y="10" width="14" height="10" rx="2" ry="2"/>
                            <circle cx="12" cy="15" r="1"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
        <div class="top-bar-right">
            <div class="rounded-controls">
                <div class="rounded-controls-child">
                    <button type="button" id="edit-mode-button" button="edit-mode-button" class="button" @onclick="OpenEditMenu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                              <path d="m9.951,11.189c.565.553,1.307.828,2.048.828s1.484-.275,2.049-.828l1.84-1.801c1.039-1.038,1.611-2.419,1.611-3.889s-.572-2.85-1.611-3.889h0c-1.039-1.039-2.419-1.611-3.889-1.611s-2.85.572-3.889,1.611c-1.039,1.038-1.611,2.42-1.611,3.889s.572,2.851,1.619,3.896l1.833,1.793Zm-.426-8.164c.661-.661,1.541-1.025,2.475-1.025s1.813.364,2.474,1.025h0c.661.661,1.025,1.54,1.025,2.475s-.364,1.813-1.018,2.467l-1.833,1.793c-.358.35-.941.35-1.3,0l-1.825-1.785c-.661-.661-1.025-1.54-1.025-2.475s.364-1.813,1.025-2.475Zm.975,2.469c0-.828.672-1.5,1.5-1.5s1.5.672,1.5,1.5-.672,1.5-1.5,1.5-1.5-.672-1.5-1.5Zm13.498,13.259l-.979-8.318c-.186-1.58-1.147-2.947-2.573-3.658-.496-.248-1.095-.044-1.341.449-.246.495-.045,1.095.449,1.342.819.407,1.372,1.192,1.478,2.101l.079.671-10.529,5.014-7.289-6.535c.25-.517.645-.956,1.169-1.229.49-.255.68-.859.424-1.349-.255-.491-.858-.681-1.349-.425-1.381.72-2.314,2.072-2.496,3.618L.063,18.753c-.157,1.331.264,2.67,1.155,3.671.891,1.002,2.17,1.576,3.51,1.576h14.604c1.34,0,2.62-.574,3.51-1.576.891-1.001,1.312-2.339,1.156-3.671Zm-21.285,2.342c-.511-.575-.753-1.343-.663-2.107l.809-6.875,11.029,9.888H4.728c-.77,0-1.504-.33-2.016-.905Zm18.635,0c-.512.575-1.246.905-2.016.905h-2.45l-4.685-4.2,9.161-4.362.653,5.55c.09.764-.152,1.532-.664,2.107Z"/>
                        </svg>
                    </button>
                </div>
                <div class="rounded-controls-child">
                    <button type="button" id="start-finish-button" button="start-finish-button" class="button" @onclick="ToggleStartFinishMode">
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                           <path d="M5.005,24.006c-.548,0-1.097-.198-1.524-.596l-1.99-1.849c-1.976-1.975-1.976-5.147-.026-7.096,.945-.944,2.201-1.464,3.536-1.464s2.591,.52,3.535,1.464h0c.945,.944,1.465,2.2,1.465,3.536s-.52,2.591-1.465,3.535l-2.001,1.871c-.428,.4-.978,.6-1.528,.6Zm-.005-9.006c-.801,0-1.555,.312-2.122,.879-1.169,1.169-1.169,3.072,0,4.242l1.964,1.824c.092,.085,.234,.085,.326,0l1.977-1.847c.542-.543,.854-1.296,.854-2.098s-.312-1.555-.879-2.122h0c-.566-.566-1.32-.878-2.121-.878Zm14.005-3.994c-.548,0-1.097-.199-1.524-.596l-1.99-1.849c-1.976-1.975-1.976-5.147-.026-7.096,.944-.944,2.2-1.464,3.536-1.464s2.59,.52,3.535,1.464h0c1.95,1.95,1.95,5.122,0,7.071l-2.001,1.871c-.428,.4-.979,.6-1.529,.6Zm-.005-9.006c-.802,0-1.555,.312-2.122,.878-1.169,1.17-1.169,3.073,0,4.243l1.963,1.824c.093,.086,.236,.084,.327,0l1.977-1.847c1.145-1.146,1.145-3.049-.024-4.219h0c-.567-.567-1.32-.879-2.121-.879Zm5,18c0-2.206-1.794-4-4-4h-5c-1.103,0-2-.897-2-2,0-.847,.536-1.604,1.333-1.886,.521-.184,.794-.755,.61-1.276-.184-.521-.754-.795-1.276-.61-1.595,.563-2.667,2.08-2.667,3.772,0,2.206,1.794,4,4,4h5c1.103,0,2,.897,2,2s-.897,2-2,2H11c-.552,0-1,.448-1,1s.448,1,1,1h9c2.206,0,4-1.794,4-4Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="edit-menu" class="edit-menu">
            <button type="button" id="edit-menu-edit-button" class="edit-tool-button" @onclick="ToggleEditMode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12">
                    <path d="M22.853,1.148a3.626,3.626,0,0,0-5.124,0L1.465,17.412A4.968,4.968,0,0,0,0,20.947V23a1,1,0,0,0,1,1H3.053a4.966,4.966,0,0,0,3.535-1.464L22.853,6.271A3.626,3.626,0,0,0,22.853,1.148ZM5.174,21.122A3.022,3.022,0,0,1,3.053,22H2V20.947a2.98,2.98,0,0,1,.879-2.121L15.222,6.483l2.3,2.3ZM21.438,4.857,18.932,7.364l-2.3-2.295,2.507-2.507a1.623,1.623,0,1,1,2.295,2.3Z"/>
                </svg>
            </button>
            <button id="edit-menu-delete-button" class="edit-tool-button" @onclick="ToggleDeleteMode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12">
                    <path d="m23,21h-8.633l8.174-8.205c1.939-1.946,1.939-5.113,0-7.06l-3.254-3.265c-.945-.948-2.203-1.47-3.541-1.47s-2.597.522-3.54,1.468L1.459,13.175c-1.939,1.946-1.939,5.113,0,7.059l1.583,1.589c.745.748,1.777,1.177,2.834,1.177h17.124c.553,0,1-.448,1-1s-.447-1-1-1ZM13.62,3.882c.567-.569,1.322-.882,2.126-.882s1.558.313,2.125.882l3.254,3.265c1.163,1.167,1.163,3.068,0,4.236l-4.97,4.989-7.509-7.534,4.974-4.955Zm-7.744,17.118c-.536,0-1.039-.209-1.417-.588l-1.584-1.589c-1.163-1.167-1.163-3.067-.002-4.232l4.357-4.341,7.514,7.54-3.199,3.211h-5.669Z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="drone-menu-container">
        <div class="drone-menu-header @(drones.Count == 0 ? "" : "active")">
            <span class="drone-menu-header-text">Список дронов</span>
            <button id="add-drone-button" @onclick="ShowAddDroneModal" type="button" class="button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 5.992c0-.537.448-.992 1-.992.556 0 1 .444 1 .992V11h5.008c.537 0 .992.448.992 1 0 .556-.444 1-.992 1H13v5.008c0 .537-.448.992-1 .992-.556 0-1-.444-1-.992V13H5.992C5.455 13 5 12.552 5 12c0-.556.444-1 .992-1H11V5.992z"/>
                </svg>
            </button>
        </div>
        <div class="drone-menu-list">
            @foreach (var item in drones)
            {
                <div class="drone-item @(item.IsSelected ? "selected expanded" : "")" @onclick="() => SelectDroneItem(item)">
                    <div class="drone-content">
                        <div class="drone-info">
                            <input type="color" class="color-picker" value="@item.Color" @onchange="(e) => OnColorChanged(item, e)" />
                            <div class="drone-name-container">
                                <span class="drone-name" @onclick="() => EditDrone(item)">@item.Name</span>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(item.Description))
                            {
                                <span class="drone-description">@item.Description</span>
                            }
                            <button @onclick="() => DroneRemove(item)" class="remove-drone-button">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 6 L18 18 M18 6 L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="drone-details">
                            @if (item.IsSelected)
                            {
                                <div class="path-info">
                                    <span>Длина маршрута</span>&nbsp;
                                    <span class="path-length @GetPathLengthClass(item)">
                                        @{
                                            var length = item.Path?.CalculateLength() ?? 0;
                                            if (length >= 1000)
                                            {
                                                <text>@((length / 1000).ToString("F1")) км</text>
                                            }
                                            else
                                            {
                                                <text>@(length.ToString("F0")) м</text>
                                            }
                                        }
                                    </span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="custom-zoom-controls">
        <button id="zoom-in" class="button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11 5.992c0-.537.448-.992 1-.992.556 0 1 .444 1 .992V11h5.008c.537 0 .992.448.992 1 0 .556-.444 1-.992 1H13v5.008c0 .537-.448.992-1 .992-.556 0-1-.444-1-.992V13H5.992C5.455 13 5 12.552 5 12c0-.556.444-1 .992-1H11V5.992z"/>
            </svg>
        </button>
        <button id="zoom-out" class="button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M5 12a1 1 0 0 1 1-1h12a1 1 0 1 1 0 2H6a1 1 0 0 1-1-1z"/>
            </svg>
        </button>
    </div>

    <div id="map" style="width: 100%; height: 100vh;"></div>

   <div class="@($"modal-overlay {(showDroneModal ? "active" : "")}")">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Характеристики БПЛА</h3>
                <button class="modal-close-button" @onclick="CloseDroneModal">                        
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 6 L18 18 M18 6 L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название</label>
                    <div class="input-row">
                        <input type="text" 
                            class="form-input @(!string.IsNullOrEmpty(nameError) ? "invalid" : "")" 
                            value="@currentDrone.Name"
                            @oninput="HandleNameInput"
                            placeholder="Название БПЛА" 
                            maxlength="24"/>
                        <input type="color" class="color-picker" @bind="currentDrone.Color"/>
                    </div>
                    @if (!string.IsNullOrEmpty(nameError))
                    {
                        <div class="validation-error">@nameError</div>
                    }
                </div>

                <div class="form-group">
                    <label>Описание</label>
                    <input type="text" class="form-input" @bind="currentDrone.Description" placeholder="Добавьте описание" maxlength="24"/>
                </div>

                <div class="form-group">
                    <label>Дальность полета</label>
                    <div class="input-with-unit">
                        <input type="number" 
                            class="form-input @(!string.IsNullOrEmpty(flightRangeError) ? "invalid" : "")" 
                            value="@(isKmFlight ? (currentDrone.FlightRange / 1000).ToString("0.0") : currentDrone.FlightRange.ToString())"
                            @oninput="e => HandleFlightRangeInput(e, isKmFlight)"
                            min="0.1"
                            max="1000"
                            placeholder="100"
                            step="@(isKmFlight ? "0.1" : "1")" />
                        <div class="unit-selector">
                            <button class="unit-btn @(isKmFlight ? "active" : "")" 
                                    @onclick="@(() => ToggleUnit(true, "flight"))">км</button>

                            <button class="unit-btn @(!isKmFlight ? "active" : "")" 
                                    @onclick="@(() => ToggleUnit(false, "flight"))">м</button>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(flightRangeError))
                    {
                        <div class="validation-error">@flightRangeError</div>
                    }
                </div>

                <div class="form-group">
                    <label>Радиус обзора</label>
                    <div class="input-with-unit">
                        <input type="number" 
                            class="form-input @(!string.IsNullOrEmpty(radiusError) ? "invalid" : "")" 
                            value="@currentDrone.Radius"
                            @oninput="e => HandleRadiusInput(e, false)"
                            placeholder="10"
                            min="10" 
                            max="5000" 
                            step="1" />
                        <div class="unit-selector">
                            <button class="unit-btn active">м</button>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(radiusError))
                    {
                        <div class="validation-error">@radiusError</div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" @onclick="SaveDrone">
                    @(isEditingDrone ? "Сохранить" : "Добавить")
                </button>
            </div>
        </div>
    </div>
</div>